<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Laam DEX</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
<style>
  :root{
    --bg1:#0f2027; --bg2:#203a43; --bg3:#2c5364;
    --card:#1e2a38; --card2:#22354b;
    --text:#e6eef6; --muted:#97a6b8;
    --brand:#ffd36b; --brand2:#ffca3a; --line:#395269;
    --ok:#34d399; --warn:#fbbf24; --err:#f87171;
    --maxw: 920px; --rad:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background: linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
    min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:24px 14px;
  }
  .app{ width:100%; max-width:var(--maxw); text-align:center; }
  h1{
    margin:0 0 18px 0; font-size:2.2rem; font-weight:800; color:var(--brand);
    text-shadow:0 0 12px rgba(255,211,107,.7);
  }
  .card{
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
    border-radius: var(--rad);
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    padding:18px;
    margin:14px auto;
  }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  .grid-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:14px; }
  @media (max-width:820px){ .grid-2,.grid-3{ grid-template-columns:1fr; } }

  label{ display:block; text-align:left; margin:6px 0 6px; font-weight:600; color:var(--brand); }
  input, select, button, textarea{
    width:100%; padding:12px 14px; border:none; border-radius:12px; font-size:1rem;
    background: var(--card); color:var(--text); outline:none;
    box-shadow: inset 0 0 10px rgba(0,0,0,.25);
  }
  input::placeholder{ color:var(--muted); }
  select{ background:var(--card2); cursor:pointer; }
  button{
    background: var(--brand); color:#071422; font-weight:800; letter-spacing:.02em;
    box-shadow: 0 8px 18px rgba(255,211,107,.55); cursor:pointer; text-transform:uppercase;
  }
  button:hover{ background:var(--brand2); box-shadow:0 12px 28px rgba(255,202,58,.75); }
  button:disabled{ background:#8a8a8a; cursor:not-allowed; box-shadow:none; }

  .mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    background:var(--card2); padding:10px 12px; border-radius:12px;
    overflow-wrap:anywhere; word-break:break-word;
  }

  hr{
    border:none; border-top:1px solid var(--line); margin:20px 0;
  }

  /* Buy/Sell panels */
  .trade-panels{ gap:16px; }
  .panel{
    background: rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
    border-radius:14px; padding:14px;
  }
  .panel h3{ margin:0 0 10px 0; font-size:1.1rem; color:var(--brand); }
  .buy .panel h3::before{ content:"BUY"; color:var(--ok); margin-right:8px; font-weight:900; }
  .sell .panel h3::before{ content:"SELL"; color:var(--err); margin-right:8px; font-weight:900; }

  /* Tables */
  table{ width:100%; border-collapse:separate; border-spacing:0 10px; }
  thead th{ text-align:center; color:var(--brand); padding:6px 8px; }
  tbody td{
    text-align:center; background:var(--card); padding:12px 10px; border-radius:12px;
  }
  tbody tr:hover td{ background:var(--card2); }

  #status{
    min-height:28px; font-weight:700; color:var(--brand); text-shadow:0 0 8px var(--brand);
  }

  .inline-actions{ display:flex; gap:10px; flex-wrap:wrap; }
  .muted{ color:var(--muted); font-size:.92rem; }
  .balances{
    display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;
  }
  .pill{
    background:var(--card2); border:1px solid rgba(255,255,255,.1);
    padding:8px 12px; border-radius:999px; font-weight:700;
  }

  .send-wrap{ display:none; margin-top:10px; text-align:left; }
  .send-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  @media (max-width:640px){ .send-row{ grid-template-columns:1fr; } }
</style>
</head>
<body>
  <div class="app">
    <h1>Laam DEX</h1>

    <!-- BALANCES + SEND -->
    <div class="card">
      <div class="balances">
        <span class="pill">XLM: <span id="xlmBal">0.00</span></span>
        <span class="pill">Laam: <span id="laamBal">0.00</span></span>
      </div>
      <div class="inline-actions" style="justify-content:center; margin-top:10px;">
        <button id="btnSendToggle" style="max-width:220px;">Send</button>
      </div>

      <div id="sendForm" class="send-wrap">
        <div class="send-row">
          <div>
            <label for="sendAsset">Asset</label>
            <select id="sendAsset">
              <option value="XLM">XLM (native)</option>
              <option value="LAAM">Laam (token)</option>
            </select>
          </div>
          <div>
            <label for="sendAmount">Amount</label>
            <input id="sendAmount" type="number" step="0.0000001" placeholder="e.g. 10" />
          </div>
        </div>
        <label for="sendDest" style="margin-top:8px;">Destination Public Key</label>
        <input id="sendDest" type="text" placeholder="G... destination" />
        <div class="muted" style="margin-top:6px;">
          Note: Sending Laam requires the receiver to have a Laam trustline, otherwise the payment may fail.
        </div>
        <div class="inline-actions" style="margin-top:10px;">
          <button id="btnSend" style="flex:1;">Send Now</button>
          <button id="btnSendCancel" style="flex:1; background:#cbd5e1; color:#0f172a; text-transform:none;">Cancel</button>
        </div>
      </div>
    </div>

    <!-- CREATE ACCOUNT + LOGIN -->
    <div class="card">
      <div class="grid-2">
        <div>
          <h3 style="margin:0 0 6px 0; color:var(--brand)">Create New Account</h3>
          <button id="createAccount">Generate New Stellar Account</button>
          <label style="margin-top:10px;">New Secret Key</label>
          <div id="newSecret" class="mono">-</div>
          <label style="margin-top:10px;">New Public Key</label>
          <div id="newPublic" class="mono">-</div>
          <div class="muted" style="margin-top:6px;">* Save your secret key in a safe place.</div>
        </div>
        <div>
          <h3 style="margin:0 0 6px 0; color:var(--brand)">Login</h3>
          <label>Secret Key</label>
          <input id="secretKey" type="password" placeholder="SB..."/>
          <div class="inline-actions" style="margin-top:10px;">
            <button id="loadAccountBtn">Load Account</button>
            <button id="addTrustlineBtn" disabled>Add Laam Trustline</button>
          </div>
          <label style="margin-top:10px;">Your Public Key</label>
          <div id="pubKey" class="mono">-</div>
        </div>
      </div>
      <div id="status" style="margin-top:10px;"></div>
    </div>

    <!-- TRADE PANELS -->
    <div class="card trade-panels grid-2">
      <div class="panel buy">
        <h3>Laam (Pay XLM)</h3>
        <label>Price (XLM per Laam)</label>
        <input id="buyPrice" type="number" step="0.0000001" placeholder="e.g. 0.135" />
        <label style="margin-top:8px;">Amount (Laam)</label>
        <input id="buyAmount" type="number" step="0.0000001" placeholder="e.g. 100" />
        <button id="btnPlaceBuy" style="margin-top:10px;">Place Buy Offer</button>
      </div>

      <div class="panel sell">
        <h3>Laam (Get XLM)</h3>
        <label>Price (XLM per Laam)</label>
        <input id="sellPrice" type="number" step="0.0000001" placeholder="e.g. 0.135" />
        <label style="margin-top:8px;">Amount (Laam)</label>
        <input id="sellAmount" type="number" step="0.0000001" placeholder="e.g. 100" />
        <button id="btnPlaceSell" style="margin-top:10px;">Place Sell Offer</button>
      </div>
    </div>

    <!-- ORDERBOOK -->
    <div class="card">
      <h3 style="margin:0 0 10px 0; color:var(--brand)">Market Offers</h3>
      <div class="grid-2">
        <div>
          <h4 style="margin:0 0 8px 0; color:var(--ok);">Buy Offers (Bids)</h4>
          <table>
            <thead>
              <tr><th>Price (XLM/Laam)</th><th>Amount (Laam)</th><th>Total (XLM)</th></tr>
            </thead>
            <tbody id="bidsBody"></tbody>
          </table>
        </div>
        <div>
          <h4 style="margin:0 0 8px 0; color:var(--err);">Sell Offers (Asks)</h4>
          <table>
            <thead>
              <tr><th>Price (XLM/Laam)</th><th>Amount (Laam)</th><th>Total (XLM)</th></tr>
            </thead>
            <tbody id="asksBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="muted" style="margin:10px auto; max-width:var(--maxw);">
      Tip: Fund your account with a small amount of XLM for fees. Laam issuer: <span class="mono">GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64</span>
    </div>
  </div>

<script>
  // === Stellar setup (MAINNET) ===
  const server = new StellarSdk.Server('https://horizon.stellar.org');
  const ISSUER = 'GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64';
  const LAAM  = new StellarSdk.Asset('Laam', ISSUER);
  const XLM   = StellarSdk.Asset.native();

  // === State ===
  let keypair = null;
  let account = null;
  let balTimer = null;

  // === UI refs ===
  const statusEl = document.getElementById('status');
  const xlmBalEl = document.getElementById('xlmBal');
  const laamBalEl= document.getElementById('laamBal');
  const pubKeyEl = document.getElementById('pubKey');
  const addTLBtn = document.getElementById('addTrustlineBtn');

  const bidsBody = document.getElementById('bidsBody');
  const asksBody = document.getElementById('asksBody');

  function setStatus(msg=''){ statusEl.textContent = msg; }
  function errText(e){
    try{
      const ops = e?.response?.data?.extras?.result_codes?.operations;
      if (ops) return Array.isArray(ops) ? ops.join(', ') : ops;
      const txc = e?.response?.data?.extras?.result_codes?.transaction;
      if (txc) return txc;
    }catch(_){}
    return (e?.message || String(e));
  }
  function fmt(n, d=7){ const x = parseFloat(n); if(!isFinite(x)) return '-'; return x.toFixed(d); }
  function invert(p){ const x = parseFloat(p); return (!isFinite(x) || x===0) ? 0 : 1/x; }

  // === Balances ===
  function renderBalances(balances){
    let xlm = 0, laam = 0;
    for (const b of balances){
      if (b.asset_type === 'native') xlm = parseFloat(b.balance);
      if (b.asset_code === 'Laam' && b.asset_issuer === ISSUER) laam = parseFloat(b.balance);
    }
    xlmBalEl.textContent  = fmt(xlm,2);
    laamBalEl.textContent = fmt(laam,2);
  }

  async function refreshBalances(){
    if (!keypair) return;
    try{
      account = await server.loadAccount(keypair.publicKey());
      renderBalances(account.balances);
    }catch(e){ console.error('refreshBalances', e); }
  }

  // === Create Account (local generate) ===
  document.getElementById('createAccount').addEventListener('click', ()=>{
    const kp = StellarSdk.Keypair.random();
    document.getElementById('newSecret').textContent = kp.secret();
    document.getElementById('newPublic').textContent = kp.publicKey();
    setStatus('New keypair generated. Fund the public key with XLM to activate.');
  });

  // === Login / Load ===
  document.getElementById('loadAccountBtn').addEventListener('click', async ()=>{
    const sec = document.getElementById('secretKey').value.trim();
    if (!sec){ alert('Enter your secret key'); return; }
    try{
      keypair = StellarSdk.Keypair.fromSecret(sec);
      account = await server.loadAccount(keypair.publicKey());
      pubKeyEl.textContent = keypair.publicKey();
      setStatus('Account loaded.');
      addTLBtn.disabled = false;
      renderBalances(account.balances);
      if (balTimer) clearInterval(balTimer);
      balTimer = setInterval(refreshBalances, 10000);
      await loadOrderbook();
    }catch(e){
      keypair = null; account = null; addTLBtn.disabled = true;
      pubKeyEl.textContent = '-';
      setStatus('Error loading account: ' + errText(e));
    }
  });

  // === Add Trustline (Laam) ===
  document.getElementById('addTrustlineBtn').addEventListener('click', async ()=>{
    if (!account || !keypair){ alert('Load your account first.'); return; }
    try{
      const exists = account.balances.some(b=> b.asset_code==='Laam' && b.asset_issuer===ISSUER);
      if (exists){ setStatus('Trustline already exists.'); return; }

      const fee = await server.fetchBaseFee();
      const tx = new StellarSdk.TransactionBuilder(account, {fee, networkPassphrase: StellarSdk.Networks.PUBLIC})
        .addOperation(StellarSdk.Operation.changeTrust({ asset: LAAM }))
        .setTimeout(30)
        .build();
      tx.sign(keypair);
      const res = await server.submitTransaction(tx);
      setStatus('Trustline added. Tx: '+res.hash);
      await refreshBalances();
    }catch(e){ setStatus('Error (trustline): '+errText(e)); }
  });

  // === Place Buy (sell XLM, buy Laam) ===
  document.getElementById('btnPlaceBuy').addEventListener('click', async ()=>{
    if (!account || !keypair){ alert('Load your account first.'); return; }
    const priceXLMperLaam = parseFloat(document.getElementById('buyPrice').value);
    const amountLaam = parseFloat(document.getElementById('buyAmount').value);
    if (!(priceXLMperLaam>0) || !(amountLaam>0)){ alert('Enter valid price & amount'); return; }

    // Horizon expects Laam per XLM => invert UI price
    const priceLaamPerXLM = 1 / priceXLMperLaam;

    try{
      const fresh = await server.loadAccount(keypair.publicKey());
      const fee = await server.fetchBaseFee();
      const tx = new StellarSdk.TransactionBuilder(fresh, {fee, networkPassphrase: StellarSdk.Networks.PUBLIC})
        .addOperation(StellarSdk.Operation.manageSellOffer({
          selling: XLM, buying: LAAM,
          amount: amountLaam.toFixed(7), // spend XLM computed by price on matching
          price: priceLaamPerXLM.toString(),
          offerId: '0'
        }))
        .setTimeout(30)
        .build();
      tx.sign(keypair);
      const res = await server.submitTransaction(tx);
      setStatus('Buy offer placed. Tx: '+res.hash);
      await refreshBalances(); await loadOrderbook();
    }catch(e){ setStatus('Error (buy offer): '+errText(e)); }
  });

  // === Place Sell (sell Laam, get XLM) ===
  document.getElementById('btnPlaceSell').addEventListener('click', async ()=>{
    if (!account || !keypair){ alert('Load your account first.'); return; }
    const priceXLMperLaam = parseFloat(document.getElementById('sellPrice').value);
    const amountLaam = parseFloat(document.getElementById('sellAmount').value);
    if (!(priceXLMperLaam>0) || !(amountLaam>0)){ alert('Enter valid price & amount'); return; }

    // Horizon expects Laam per XLM => invert UI price
    const priceLaamPerXLM = 1 / priceXLMperLaam;

    try{
      const fresh = await server.loadAccount(keypair.publicKey());
      const fee = await server.fetchBaseFee();
      const tx = new StellarSdk.TransactionBuilder(fresh, {fee, networkPassphrase: StellarSdk.Networks.PUBLIC})
        .addOperation(StellarSdk.Operation.manageSellOffer({
          selling: LAAM, buying: XLM,
          amount: amountLaam.toFixed(7),
          price: priceLaamPerXLM.toString(),
          offerId: '0'
        }))
        .setTimeout(30)
        .build();
      tx.sign(keypair);
      const res = await server.submitTransaction(tx);
      setStatus('Sell offer placed. Tx: '+res.hash);
      await refreshBalances(); await loadOrderbook();
    }catch(e){ setStatus('Error (sell offer): '+errText(e)); }
  });

  // === Orderbook (show XLM/Laam) ===
  async function loadOrderbook(){
    try{
      // Orderbook for selling Laam, buying XLM
      const ob = await server.orderbook(LAAM, XLM).call();

      function rowHTML(priceXLMperLaam, amtLaam){
        const totalXLM = priceXLMperLaam * amtLaam;
        return `<tr>
          <td>${fmt(priceXLMperLaam)}</td>
          <td>${fmt(amtLaam)}</td>
          <td>${fmt(totalXLM)}</td>
        </tr>`;
      }

      // Bids = offers to BUY LAAM (pay XLM)
      bidsBody.innerHTML = ob.bids.length
        ? ob.bids.map(b=>{
            const px = invert(b.price);      // show XLM per Laam
            const amt= parseFloat(b.amount); // Laam
            return rowHTML(px, amt);
          }).join('')
        : `<tr><td colspan="3" class="muted">No buy offers</td></tr>`;

      // Asks = offers to SELL LAAM (get XLM)
      asksBody.innerHTML = ob.asks.length
        ? ob.asks.map(a=>{
            const px = invert(a.price);      // show XLM per Laam
            const amt= parseFloat(a.amount); // Laam
            return rowHTML(px, amt);
          }).join('')
        : `<tr><td colspan="3" class="muted">No sell offers</td></tr>`;
    }catch(e){
      console.error(e);
      bidsBody.innerHTML = `<tr><td colspan="3" style="color:#f87171">Error</td></tr>`;
      asksBody.innerHTML = `<tr><td colspan="3" style="color:#f87171">Error</td></tr>`;
      setStatus('Error loading orderbook');
    }
  }

  // === Send flow ===
  const sendWrap = document.getElementById('sendForm');
  document.getElementById('btnSendToggle').addEventListener('click', ()=>{
    sendWrap.style.display = sendWrap.style.display==='block' ? 'none' : 'block';
  });
  document.getElementById('btnSendCancel').addEventListener('click', ()=>{
    sendWrap.style.display='none';
  });

  document.getElementById('btnSend').addEventListener('click', async ()=>{
    if (!account || !keypair){ alert('Load your account first.'); return; }
    const assetSel = document.getElementById('sendAsset').value;
    const amount   = parseFloat(document.getElementById('sendAmount').value);
    const dest     = document.getElementById('sendDest').value.trim();

    if (!dest || !(amount>0)){ alert('Enter destination and valid amount'); return; }

    const asset = (assetSel==='XLM') ? XLM : LAAM;

    try{
      const fresh = await server.loadAccount(keypair.publicKey());
      const fee = await server.fetchBaseFee();

      const tx = new StellarSdk.TransactionBuilder(fresh, {fee, networkPassphrase: StellarSdk.Networks.PUBLIC})
        .addOperation(StellarSdk.Operation.payment({ destination: dest, asset, amount: amount.toFixed(7) }))
        .setTimeout(30)
        .build();
      tx.sign(keypair);
      const res = await server.submitTransaction(tx);
      setStatus('Sent '+amount+' '+assetSel+'. Tx: '+res.hash);
      sendWrap.style.display='none';
      await refreshBalances();
    }catch(e){
      setStatus('Error sending: '+errText(e));
    }
  });

  // Initial load
  (async ()=>{ await loadOrderbook(); })();
</script>
</body>
            </html>
